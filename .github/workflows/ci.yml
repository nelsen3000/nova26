name: Nova26 CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Check TypeScript
        run: npx tsc --noEmit

  unit-integration:
    name: Unit + Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run tests
        run: npx vitest run --reporter=verbose --exclude='**/property-tests*'
      - name: Report results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (context.eventName === 'pull_request') {
              const summary = `Test run completed on commit ${context.sha.slice(0, 7)}.`;
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary,
              });
            }

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run property-based tests
        run: npx vitest run --reporter=verbose src/taste-vault/property-tests.ts
        timeout-minutes: 10

  snapshot-check:
    name: Prompt Snapshot Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Check for prompt drift
        run: npx vitest run --reporter=verbose src/testing/prompt-snapshots.test.ts
      - name: Fail on unexpected snapshot drift
        run: |
          if git diff --name-only | grep -q '\.snap$'; then
            echo "ERROR: Prompt snapshots have drifted. Run 'nova26 test --update-snapshots'"
            echo "and commit the updated .snap files."
            exit 1
          fi
