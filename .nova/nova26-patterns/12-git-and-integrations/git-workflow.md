# Git Workflow

## Source
Extracted from Nova26 `src/git/workflow.ts`

---

## Pattern: Git Workflow

An automated git operations pipeline that manages the full branch-commit-PR lifecycle for agent-generated code. When the Ralph Loop orchestrator completes a PRD build, this module handles branch creation (namespaced under `nova26/`), per-phase commits with conventional commit messages, and GitHub PR creation via the `gh` CLI.

The key insight is that AI-generated code changes should follow the same git discipline as human changes — feature branches, atomic commits per phase, and PRs with structured summaries — so that code review and rollback work identically regardless of who (or what) authored the code.

---

## Implementation

### Code Example

```typescript
import { execSync } from 'child_process';

export interface GitWorkflowConfig {
  autoCommit: boolean;        // Commit after each phase
  autoPR: boolean;            // Create PR on completion
  branchPrefix: string;       // Branch name prefix
  commitPrefix: string;       // Conventional commit prefix
}

const DEFAULT_CONFIG: GitWorkflowConfig = {
  autoCommit: true,
  autoPR: true,
  branchPrefix: 'nova26/',
  commitPrefix: 'feat',
};

/**
 * Check if we're in a git repository
 */
export function isGitRepo(): boolean {
  try {
    execSync('git rev-parse --git-dir', { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Create a feature branch for a PRD build.
 * Sanitizes the PRD name into a safe branch name, stashes uncommitted
 * changes, and creates or switches to the target branch.
 */
export function createBranch(
  prdName: string,
  config: GitWorkflowConfig = DEFAULT_CONFIG
): string {
  if (!isGitRepo()) {
    console.log('Not a git repository, skipping branch creation');
    return getCurrentBranch();
  }

  const safeName = prdName
    .toLowerCase()
    .replace(/[^a-z0-9-]/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .slice(0, 50);

  const branchName = `${config.branchPrefix}${safeName}`;
  const currentBranch = getCurrentBranch();

  // Don't create if already on a nova branch
  if (currentBranch.startsWith(config.branchPrefix)) {
    return currentBranch;
  }

  try {
    // Stash uncommitted changes before switching
    const status = execSync('git status --porcelain', { encoding: 'utf-8' }).trim();
    if (status) {
      execSync('git stash push -m "nova26-auto-stash"', { stdio: 'pipe' });
    }

    execSync(`git checkout -b "${branchName}"`, { stdio: 'pipe' });
    return branchName;
  } catch {
    // Branch might already exist — switch to it
    try {
      execSync(`git checkout "${branchName}"`, { stdio: 'pipe' });
      return branchName;
    } catch {
      return currentBranch;
    }
  }
}

/**
 * Commit changes for a completed phase with conventional commit format.
 */
export function commitPhase(
  taskId: string,
  taskTitle: string,
  agentName: string,
  phase: number,
  config: GitWorkflowConfig = DEFAULT_CONFIG
): boolean {
  if (!isGitRepo() || !config.autoCommit) return false;

  try {
    const status = execSync('git status --porcelain', { encoding: 'utf-8' }).trim();
    if (!status) return false;

    execSync('git add .nova/output/', { stdio: 'pipe' });

    const message = `${config.commitPrefix}(${agentName.toLowerCase()}): ${taskTitle}\n\n` +
      `Task: ${taskId}\nPhase: ${phase}\nAgent: ${agentName}\n\nGenerated by NOVA26 Ralph Loop`;

    execSync(`git commit -m "${message.replace(/"/g, '\\"')}"`, { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Create a Pull Request on build completion using the gh CLI.
 */
export function createPR(
  prdName: string,
  taskSummary: string[],
  config: GitWorkflowConfig = DEFAULT_CONFIG
): string | null {
  if (!isGitRepo() || !config.autoPR || !isGhAvailable()) return null;

  const currentBranch = getCurrentBranch();
  const defaultBranch = getDefaultBranch();
  if (currentBranch === defaultBranch) return null;

  try {
    execSync(`git push -u origin "${currentBranch}"`, { stdio: 'pipe' });

    const body = [
      '## Summary',
      `Generated by NOVA26 for PRD: **${prdName}**`,
      '### Completed Tasks',
      ...taskSummary.map(t => `- ${t}`),
      '### Quality Gates',
      '- All MERCURY validations passed',
    ].join('\n');

    const title = `feat: ${prdName}`;
    return execSync(
      `gh pr create --title "${title}" --body "${body}" --base "${defaultBranch}"`,
      { encoding: 'utf-8' }
    ).trim();
  } catch {
    return null;
  }
}

/**
 * Full workflow: create branch → execute → commit phases → create PR.
 * Returns a handle with closures for phase commits and finalization.
 */
export function initWorkflow(
  prdName: string,
  config?: Partial<GitWorkflowConfig>
): {
  branch: string;
  commitPhase: (taskId: string, title: string, agent: string, phase: number) => boolean;
  finalize: (taskSummary: string[]) => string | null;
} {
  const cfg = { ...DEFAULT_CONFIG, ...config };
  const branch = createBranch(prdName, cfg);

  return {
    branch,
    commitPhase: (taskId, title, agent, phase) =>
      commitPhase(taskId, title, agent, phase, cfg),
    finalize: (taskSummary) => createPR(prdName, taskSummary, cfg),
  };
}
```

### Key Concepts

- **Namespaced branches**: All agent-created branches live under `nova26/` prefix, making them instantly identifiable and easy to clean up with `git branch --list 'nova26/*'`
- **Safe branch naming**: PRD names are sanitized (lowercased, special chars stripped, truncated to 50 chars) to prevent git errors from invalid branch names
- **Auto-stash**: Uncommitted work is stashed before branch creation, preventing data loss when the orchestrator switches context
- **Conventional commits**: Each phase commit follows `feat(agent): title` format, enabling automated changelogs and semantic versioning
- **Workflow handle pattern**: `initWorkflow` returns a closure-based handle so the orchestrator can call `commitPhase` and `finalize` without re-passing config

---

## Anti-Patterns

### ❌ Don't Do This

```typescript
// Committing all changes in one giant commit at the end
function commitEverything(prdName: string): void {
  execSync('git add .');
  execSync(`git commit -m "nova26: ${prdName}"`);
  // One massive commit with no phase breakdown, no agent attribution,
  // impossible to review or bisect individual changes
}
```

### ✅ Do This Instead

```typescript
// Commit per phase with structured metadata
const workflow = initWorkflow('user-dashboard');

// After each agent completes its phase:
workflow.commitPhase('task-001', 'Design schema', 'PLUTO', 1);
workflow.commitPhase('task-002', 'Implement API', 'MARS', 2);
workflow.commitPhase('task-003', 'Build UI', 'VENUS', 3);

// Finalize with a PR that lists all completed tasks
const prUrl = workflow.finalize([
  'PLUTO: Designed user_profiles table',
  'MARS: Implemented CRUD mutations',
  'VENUS: Built profile editor component',
]);
```

---

## When to Use This Pattern

✅ **Use for:**
- Automating git operations after agent code generation in the Ralph Loop
- Creating auditable commit histories for AI-generated code changes
- Integrating agent output into standard GitHub PR review workflows

❌ **Don't use for:**
- Repositories that don't use git (the module silently no-ops via `isGitRepo()` checks)
- Workflows where manual commit control is preferred — disable with `autoCommit: false`

---

## Benefits

1. **Auditable AI output** — every agent phase produces a discrete commit with metadata (task ID, agent name, phase number), making it trivial to trace what changed and why
2. **Standard review flow** — PRs created by the agent system look identical to human PRs, so reviewers use their existing tools and habits
3. **Safe context switching** — auto-stash prevents data loss when the orchestrator creates branches mid-work
4. **Rollback granularity** — per-phase commits allow `git revert` of a single agent's output without losing other phases

---

## Related Patterns

- See `../01-orchestration/ralph-loop-execution.md` for the orchestrator that drives the branch → commit → PR lifecycle
- See `./issue-importer.md` for importing external issues that trigger git workflow runs
- See `../03-quality-gates/typescript-gate.md` for the validation gates that run between commits
- See `../02-agent-system/agent-loader.md` for the agent dispatch system that produces the code being committed

---

*Extracted: 2026-02-19*
